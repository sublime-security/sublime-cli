{% extends "analyze_multi.txt.j2" %}

{% block body %}
{%- if flagged_messages|length > 0 %}
{# new line #}
{# new line #}
<header>FLAGGED MESSAGES</header>
==================
{%- endif %}

{%- for msg in flagged_messages %}
  {# new line #}
  <header>MESSAGE {{loop.index}}</header>
  ------------------
  {%- if msg.extension == 'mbox' %}
  <key>Subject</key>: <value>{{msg.subject}}</value>
  {%- endif%}
  <key>File Name</key>: <value>{{msg.file_name}}</value>
  <key>Directory</key>: <value>{{msg.directory}}</value>

    {# new line #}
    <header>FLAGGED RULES</header>
    {%- for rule in msg.flagged_rule_results %}
      - <detected><bold>{{ rule.name }}</bold> flagged this message.</detected>
        <key>Source:</key> {{ rule.source }}
      {# new line #}
    {%- endfor %}

    {%- if (msg.normal_query_results + msg.falsey_query_results) | length > 0 %}
    {# new line #}
    <header>QUERIES</header>
    {%- for query in (msg.normal_query_results + msg.falsey_query_results) %}
      - <query><bold>{{ query.name }}</bold></query>
        <key>Result:</key> {{ query.result }}
        <key>Source:</key> {{ query.source }}
      {# new line #}
    {%- endfor %}
    {%- endif %}

    {%- if msg.failed_rule_results|length > 0 %}
    {# new line #}
    <header>FAILED RULES</header>
    {%- for rule in msg.failed_rule_results %}
      - <fail><bold>{{ rule.name }}</bold></fail>
        <key>Source:</key> {{ rule.source }}
      {# new line #}
    {%- endfor %}
    {%- endif %}

    {%- if msg.failed_query_results|length > 0 %}
    {# new line #}
    <header>FAILED QUERIES</header>
    {%- for query in msg.failed_query_results %}
      - <fail><bold>{{ query.name }}</bold></fail>
        <key>Source:</key> {{ query.source }}
      {# new line #}
    {%- endfor %}
    {%- endif %}

    {# new line #}
{% endfor %}



{%- if unflagged_messages|length > 0 %}
{# new line #}
<header>UNFLAGGED MESSAGES</header>
==================
{%- endif %}

{%- for msg in unflagged_messages %}
{# new line #}
  <header>MESSAGE {{loop.index}}</header>
  ------------------
  {%- if msg.extension == 'mbox' %}
  <key>Subject</key>: <value>{{msg.subject}}</value>
  {%- endif %}
  <key>File Name</key>: <value>{{msg.file_name}}</value>
  <key>Directory</key>: <value>{{msg.directory}}</value>

    {%- if (msg.normal_query_results + msg.falsey_query_results) | length > 0 %}
    {# new line #}
    <header>QUERIES</header>
    {%- for query in (msg.normal_query_results + msg.falsey_query_results) %}
      - <query><bold>{{ query.name }}</bold></query>
        <key>Result:</key> {{ query.result }}
        <key>Source:</key> {{ query.source }}
      {# new line #}
    {%- endfor %}
    {%- endif %}

    {%- if msg.failed_rule_results|length > 0 %}
    {# new line #}
    <header>FAILED RULES</header>
    {%- for rule in msg.failed_rule_results %}
      - <fail><bold>{{ rule.name }}</bold></fail>
        <key>Source:</key> {{ rule.source }}
      {# new line #}
    {%- endfor %}
    {%- endif %}

    {%- if msg.failed_query_results|length > 0 %}
    {# new line #}
    <header>FAILED QUERIES</header>
    {%- for query in msg.failed_query_results %}
      - <fail><bold>{{ query.name }}</bold></fail>
        <key>Source:</key> {{ query.source }}
      {# new line #}
    {%- endfor %}
    {%- endif %}
    {# new line #}
{% endfor %}
{% endblock %}